  - hosts: localhost
    gather_facts: no
    pre_tasks:
      - name: Login to oVirt
        ovirt_auth:
          url: "https://{{ engine_fqdn }}/ovirt-engine/api"
          username: "{{ engine_user }}"
          password: "{{ engine_password }}"
          ca_file: "{{ engine_cafile | default(omit) }}"
          insecure: "{{ engine_insecure | default(true) }}"

    tasks:

      - name: Gather info on all the virtual machines
        ovirt_vm_info:
          auth: "{{ ovirt_auth }}"
          pattern: "cluster=Default"  # Get VMs from cluster "Default"
        register: vms
  
      - name: Print the gathered info
        debug:
          var: vms.ovirt_vms

    post_tasks:
      - name: Logout from oVirt
        ovirt_auth:
          state: absent
          ovirt_auth: "{{ ovirt_auth }}"
